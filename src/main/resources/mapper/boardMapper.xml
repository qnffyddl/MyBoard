<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- SQL Mapping -->
<mapper namespace="com.example.board_0914.mapper.board.boardMapper">
    <!--
    resultType  : select 된 데이터를 반환할 (그릇)을 정해주는것 BoardDTO 객체에 담긴다
    parameterType : 자바에서 int,String 값이 들어올거란걸 인지시켜주고 , 쿼리에서 자바로 보낸 boardNo 사용한다
    -->

    <!--1.조회-->
    <select id="boardDTOList"  resultType="BoardDTO">
        select A.board_no,A.board_title,A.board_content,A.board_writer,A.board_regdate,A.board_viewcount,A.BOARD_DELETEYN,A.total_count,(total_count+1)-A.ROWNUM as rownum,B.*
        from(
                select board_no, board_title,board_content,board_writer,board_regdate,board_viewcount, BOARD_DELETEYN,
                       count(1) OVER() as total_count,
                       (row_number() over()) as rownum
                from BOARDLIST where BOARD_DELETEYN = 'N'
                group by BOARD_NO ORDER BY BOARD_NO desc
            ) A FULL JOIN FILE B
                          ON A.BOARD_NO = B.BOARD_NO_FK
        where rownum between 1 and 10
        ORDER BY rownum DESC;
    </select>

    <!--2.등록-->
    <insert id="boardWrite" parameterType="BoardDTO">
        INSERT INTO BOARDLIST
        (
            BOARD_TITLE
            , BOARD_CONTENT
            , BOARD_WRITER
            , BOARD_REGDATE
            , BOARD_VIEWCOUNT
            , BOARD_PW
            , BOARD_DELETEYN
        ) VALUES (
                     #{boardTitle}
                 ,  #{boardContent}
                 ,  #{boardWriter}
                 ,  NOW()
                 ,  0
                 ,  #{boardPw}
                 ,  'N'
                 )
    </insert>

    <!--3.상세-->
    <select id="boardDetail"  parameterType="int" resultType="BoardDTO" >
        SELECT * FROM
        BOARDLIST A FULL JOIN FILE B
            ON A.BOARD_NO = B.BOARD_NO_FK
        WHERE A.BOARD_NO = #{boardNo}
    </select>


    <!--4.수정-->
    <update id="boardUpdate" parameterType="BoardDTO">
        UPDATE BOARDLIST
        SET BOARD_MODIDATE = NOW()
          , BOARD_TITLE = #{boardTitle}
          , BOARD_CONTENT = #{boardContent}
        where board_no = #{boardNo}
    </update>

    <!--5.삭제 실무에선 등록된 회원을 삭제X-->
    <update id="boardDelete" parameterType="BoardDTO">
        UPDATE BoardList SET BOARD_DELETEYN = 'Y'
        WHERE BOARD_NO =#{boardNo}
    </update>

    <!--리스트 선택시 +1-->
    <update id="boardViewCountUpdate" parameterType="int">
        UPDATE BoardList
        SET BOARD_VIEWCOUNT = BOARD_VIEWCOUNT + 1
        WHERE BOARD_NO = #{boardNo}
    </update>

    <!--팝업 비밀번호-->
    <select id="boardPwPop"  parameterType="int" resultType="BoardDTO">
        SELECT BOARD_PW
        FROM BoardList
        WHERE BOARD_NO = #{boardNo}
    </select>

    <!-- List Page CNT-->
    <select id="boardPageAjaxList"  resultType="BoardDTO">
                select A.board_no,A.board_title,A.board_content,A.board_writer,A.board_regdate,A.board_viewcount,A.BOARD_DELETEYN,A.total_count,(total_count+1)-A.ROWNUM as rownum,B.*
        from(
                select board_no, board_title,board_content,board_writer,board_regdate,board_viewcount, BOARD_DELETEYN,
                       count(1) OVER() as total_count,
                       (row_number() over()) as rownum
                from BOARDLIST where BOARD_DELETEYN = 'N' and
                    <if test='searchField == "writer"'>
                        board_writer like '%'||#{searchText}||'%'
                    </if>
                    <if test='searchField == "title"'>
                        board_title like '%'||#{searchText}||'%'
                    </if>

                    <if test='searchField == ""'>
                        board_writer like '%'||#{searchText}||'%' or
                        board_title like '%'||#{searchText}||'%'
                    </if>
                group by BOARD_NO ORDER BY BOARD_NO desc
            ) A FULL JOIN FILE B
                          ON A.BOARD_NO = B.BOARD_NO_FK
        where rownum between #{startRow} and #{endRow} and

        ORDER BY rownum DESC;
    </select>

</mapper>